name: ODD_Tracking_Example

data:
  # Paths to preprocessed data directories
  train_dir: /share/lustre/maxhart/data/colliderml/v0/ttbar_p0/
  val_dir: /share/lustre/maxhart/data/colliderml/v0/ttbar_p0/
  test_dir: /share/lustre/maxhart/data/colliderml/v0/ttbar_p0/

  # Number of events to include in each set
  num_workers: 0
  num_train: -1
  num_test: 1000
  num_val: 100

  # Minimum pT for a particle to be deemed reconstructve in GeV
  particle_min_pt: 0.01
  particle_max_abs_eta: 4.0

  # Whether to include charged / neutral particles as targets
  particle_include_charged: true
  particle_include_neutral: true

  # Number of query slots / particles to generate per event
  event_max_num_particles: 10000

# Training stuff here
trainer:
  max_epochs: 10
  accelerator: gpu
  devices: 1
  precision: bf16-mixed
  log_every_n_steps: 10
  default_root_dir: logs
  gradient_clip_val: 0.1
  accumulate_grad_batches: 1
  enable_progress_bar: True
  val_check_interval: 500

  logger:
    class_path: hepattn.utils.loggers.MyCometLogger
    init_args:
      project: odd

  callbacks:
    # - class_path: hepattn.callbacks.Compile
    - class_path: hepattn.callbacks.InferenceTimer
    - class_path: hepattn.callbacks.SaveConfig
    - class_path: hepattn.callbacks.Checkpoint
      init_args:
        monitor: val/loss
        every_n_train_steps: 2000
    - class_path: hepattn.callbacks.PredictionWriter
      init_args:
        write_inputs: false
        write_outputs: true
        write_preds: true
        write_targets: false
        write_losses: false
    - class_path: lightning.pytorch.callbacks.ModelSummary
    - class_path: lightning.pytorch.callbacks.LearningRateMonitor
    - class_path: lightning.pytorch.callbacks.TQDMProgressBar
      init_args:
        refresh_rate: 50

model:
  optimizer: lion

  lrs_config:
    initial: 1e-5
    max: 4e-5
    end: 1e-6
    pct_start: 0.01
    skip_scheduler: false
    weight_decay: 1e-5

  mtl: false

  model:
    class_path: hepattn.models.MaskFormer
    init_args:
      dim: &dim 256
      input_sort_field: phi

      input_nets:
        class_path: torch.nn.ModuleList
        init_args:
          modules:
            - class_path: hepattn.models.InputNet
              init_args:
                input_name: sihit
                input_dtype: float32
                fields:
                  - x
                  - y
                  - z
                net:
                  class_path: hepattn.models.Dense
                  init_args:
                    input_size: 3
                    output_size: *dim
                posenc:
                  class_path: hepattn.models.posenc.PositionEncoder
                  init_args:
                    input_name: sihit
                    dim: *dim
                    fields:
                      - x
                      - y
                      - z

      encoder:
        class_path: hepattn.models.Encoder
        init_args:
          num_layers: 4
          dim: *dim
          attn_type: flash
          window_size: 512
          window_wrap: true
          hybrid_norm: true
          value_residual: true
          attn_kwargs:
            num_heads: 8

      decoder:
        num_decoder_layers: 4
        num_queries: 1000
        mask_attention: true
        use_query_masks: false
        decoder_layer_config:
          dim: *dim
          hybrid_norm: true
          attn_kwargs:
            num_heads: 8

      matcher:
        class_path: hepattn.models.matcher.Matcher
        init_args:
          default_solver: scipy
          adaptive_solver: false
          parallel_solver: true

      tasks:
        class_path: torch.nn.ModuleList
        init_args:
          modules:
            - class_path: hepattn.models.task.ObjectValidTask
              init_args:
                name: flow_valid
                input_object: query
                output_object: flow
                target_object: particle
                losses:
                  object_bce: 0.1
                costs:
                  object_bce: 1.0
                dim: *dim
                null_weight: 1.0
                mask_queries: false
                has_intermediate_loss: False

            - class_path: hepattn.models.task.ObjectHitMaskTask
              init_args:
                name: flow_sihit_assignment
                input_constituent: sihit
                input_object: query
                output_object: flow
                target_object: particle
                has_intermediate_loss: False
                losses:
                  mask_bce: 0.5
                  mask_dice: 1.0
                  #mask_focal: 1.0
                costs:
                  #mask_bce: 1.0
                  mask_dice: 1.0
                  #mask_focal: 1.0
                dim: *dim
                null_weight: 1.0
