seed_everything: 42
name: TRK-v0-full

data:
  # hypatia
  #train_dir: data/trackml/prepped/
  #val_dir: data/trackml/prepped/
  #test_dir: data/trackml/prepped/
  #hit_eval_train: /share/rcifdata/svanstroud/hepattn/src/hepattn/experiments/trackml/logs/HC-v3_20250612-T220925/ckpts/epoch=015-val_loss=0.19298_train_eval.h5
  #hit_eval_val: /share/rcifdata/svanstroud/hepattn/src/hepattn/experiments/trackml/logs/HC-v3_20250612-T220925/ckpts/epoch=015-val_loss=0.19298_val_eval.h5
  #hit_eval_test: /share/rcifdata/svanstroud/hepattn/src/hepattn/experiments/trackml/logs/HC-v3_20250612-T220925/ckpts/epoch=015-val_loss=0.19298_test_eval.h5

  # isambard
  train_dir: /projects/u5du/pduckett/data_new/train/
  val_dir: /projects/u5du/pduckett/data_new/val/
  test_dir: /projects/u5du/pduckett/data_new/test/
  hit_eval_train: /projects/u5du/pduckett/filter_evals/eta2p5pt600/epoch=100-val_loss=0.15778_train_eval.h5
  hit_eval_val: /projects/u5du/pduckett/filter_evals/eta2p5pt600/epoch=100-val_loss=0.15778_val_eval.h5
  hit_eval_test: /projects/u5du/pduckett/filter_evals/eta2p5pt600/epoch=100-val_loss=0.15778_test_eval.h5
  
  num_workers: 10
  num_train: -1
  num_test: -1
  num_val: -1

  # Select only hits from these detector volumes
  # pix barrel: 8, pix endcap: 7, 9
  # See: https://competitions.codalab.org/competitions/20112
  hit_volume_ids: [7, 8, 9]

  # Minimum pt for a particle to be deemed reconstructible
  particle_min_pt: 0.6

  # Maximum absolute eta for a particle to be deemed reconstructible
  particle_max_abs_eta: 2.5

  # Minimum number of true hits for a particle to be deemed reconstructible
  particle_min_num_hits: 3

  # Maximum number of reconstructable particles allowed in an event
  event_max_num_particles: &num_objects 2100
  strict_max_objects: false

  # Define which inputs will be available to the model
  inputs:
    hit:
      # Global hit coords
      - x
      - y
      - z
      - r
      - s
      - eta
      - phi
      - u
      - v
      - s
      # Hit local charge information
      - charge_frac
      - leta
      - lphi
      - lx
      - ly
      - lz
      - geta
      - gphi

  targets:
    particle:
      - pt
      - eta
      - phi

trainer:
  # Training stuff here
  max_epochs: 10
  accelerator: gpu
  devices: 1
  precision: bf16-mixed
  log_every_n_steps: 50
  default_root_dir: logs
  gradient_clip_val: 0.1
  enable_progress_bar: true

  #profiler:
  #  class_path: lightning.pytorch.profilers.PyTorchProfiler
  #  init_args:
  #    dirpath: ./profile_logs/
  #    filename: profile.json

  logger:
    class_path: hepattn.utils.loggers.MyCometLogger
    init_args:
      project: trackml_tracking

  callbacks:
    #- class_path: hepattn.callbacks.Compile
    - class_path: hepattn.callbacks.InferenceTimer
    - class_path: hepattn.callbacks.SaveConfig
    - class_path: hepattn.callbacks.Checkpoint
      init_args:
        monitor: val/loss
    - class_path: hepattn.callbacks.PredictionWriter
      init_args:
        write_inputs: false
        write_outputs: true
        write_preds: true
        write_targets: true
        write_losses: false
    - class_path: lightning.pytorch.callbacks.LearningRateMonitor
    - class_path: lightning.pytorch.callbacks.TQDMProgressBar
      init_args:
        refresh_rate: 50

model:
  optimizer: Lion

  # Learning rate scheduler config
  lrs_config:
    initial: 1e-5
    max: 5e-5
    end: 1e-5
    pct_start: 0.05
    skip_scheduler: false
    weight_decay: 1e-5

  # Whether to use multi task learning or not
  mtl: false

  model:
    class_path: hepattn.models.MaskFormer
    init_args:
      dim: &dim 256
      input_sort_field: phi
      input_nets:
        class_path: torch.nn.ModuleList
        init_args:
          modules:
            - class_path: hepattn.models.InputNet
              init_args:
                input_name: hit
                fields:
                  - x
                  - y
                  - z
                  - r
                  - eta
                  - phi
                  - u
                  - v
                  - s
                  - charge_frac
                  - leta
                  - lphi
                  - lx
                  - ly
                  - lz
                  - geta
                  - gphi
                net:
                  class_path: hepattn.models.Dense
                  init_args:
                    input_size: 17
                    hidden_layers: [128]
                    output_size: *dim
                    activation: SwiGLU
                posenc:
                  class_path: hepattn.models.FourierPositionEncoder
                  init_args:
                    input_name: hit
                    fields:
                      - r
                      - eta
                      - phi
                    dim: *dim
                    scale: 0.1

      encoder:
        class_path: hepattn.models.Encoder
        init_args:
          num_layers: 10
          dim: *dim
          attn_type: flash
          window_size: 512
          window_wrap: true
          hybrid_norm: true
          norm: RMSNorm
          dense_kwargs: {activation: SwiGLU}

      decoder:
        num_decoder_layers: 4
        num_queries: *num_objects
        mask_attention: true
        use_query_masks: false
        decoder_layer_config:
          dim: *dim
          norm: RMSNorm
          hybrid_norm: true
          dense_kwargs: {activation: SwiGLU}

      tasks:
        class_path: torch.nn.ModuleList
        init_args:
          modules:
            - class_path: hepattn.models.task.ObjectValidTask
              init_args:
                name: track_valid
                input_object: query
                output_object: track
                target_object: particle
                has_intermediate_loss: true
                has_first_layer_loss: false
                dim: *dim
                losses:
                  object_bce: 1.0
                costs:
                  object_bce: 1.0
                null_weight: 1.0
            - class_path: hepattn.models.task.ObjectHitMaskTask
              init_args:
                name: track_hit_valid
                input_constituent: hit
                input_object: query
                output_object: track
                target_object: particle
                dim: *dim
                constituent_net:
                  class_path: torch.nn.Linear
                  init_args:
                    in_features: *dim
                    out_features: *dim
                losses:
                  mask_dice: 2.0
                  mask_focal: 50.0
                costs:
                  mask_dice: 2.0
                  mask_focal: 50.0
                null_weight: 1.0

      matcher:
        class_path: hepattn.models.matcher.Matcher
        init_args:
          default_solver: scipy
          adaptive_solver: true
